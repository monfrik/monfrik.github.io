const headerButton=document.querySelector(".header__button"),main=document.querySelector(".main"),selectStyle=document.querySelector(".graphs__style__select"),zoomSlider=document.querySelector(".graphs__slider"),selectsValues=document.querySelectorAll(".selects__value"),selectsItemsContainers=document.querySelectorAll(".selects__items"),visualization=document.getElementById("visualization"),groups=new vis.DataSet;let stock={},indexes={},currentIndex,currentStock,currentGraphStyle,zoom=1;function parseResult(e,s){const n=JSON.parse(e).spark.result[0].response[0];return n.timestamp.map((e,t)=>({x:new Date(1e3*e).toLocaleDateString("ru").split(".").reverse().join("-"),y:n.indicators.quote[0].close[t],group:s}))}document.addEventListener("DOMContentLoaded",fetchGraph),headerButton.addEventListener("click",()=>{main.scrollIntoView({behavior:"smooth"})}),selectStyle.addEventListener("change",e=>{currentGraphStyle=e.target.value,updateGraph()}),zoomSlider.addEventListener("change",e=>{zoom=e.target.value,console.log(e.target.value),updateGraph()});async function fetchStock(){stock={Microsoft:parseResult(msft,0),Gazprom:parseResult(gazprom,0),Apple:parseResult(apple,0)}}async function fetchIndexes(){indexes={IMOEX:parseResult(imoex,1),Nasdaq:parseResult(nasdaq,1),"S&P 500":parseResult(snp500,1)}}function updateSelects(){const e=Object.entries(stock).map(([e])=>e),t=Object.entries(indexes).map(([e])=>e);for(;0!==selectsItemsContainers[0].childElementCount;)selectsItemsContainers[0].removeChild(selectsItemsContainers[0].firstChild);for(;0!==selectsItemsContainers[1].childElementCount;)selectsItemsContainers[1].removeChild(selectsItemsContainers[1].firstChild);e.forEach(e=>{const t=document.createElement("button");t.innerHTML=e,t.setAttribute("value",e),t.classList.add("selects__option"),t.addEventListener("click",()=>{currentStock=selectsValues[0].innerHTML=e,updateGraph()}),selectsItemsContainers[0].appendChild(t)}),t.forEach(e=>{const t=document.createElement("button");t.innerHTML=e,t.setAttribute("value",e),t.classList.add("selects__option"),t.addEventListener("click",()=>{currentIndex=selectsValues[1].innerHTML=e,updateGraph()}),selectsItemsContainers[1].appendChild(t)}),currentStock=selectsValues[0].innerHTML=e[0],currentIndex=selectsValues[1].innerHTML=t[0]}function updateGraph(){let e=[...stock[currentStock],...indexes[currentIndex]];var t=new vis.DataSet(e);const s=e.reduce((e,t)=>new Date(t.x).getTime()<e.getTime()?new Date(t.x):e,new Date(e[0].x)),n=e.reduce((e,t)=>new Date(t.x).getTime()>e.getTime()?new Date(t.x):e,new Date(e[0].x));s.setDate(s.getDate()-1),n.setDate(n.getDate()+1);const r={start:s.toLocaleDateString("ru").split(".").reverse().join("-"),end:n.toLocaleDateString("ru").split(".").reverse().join("-"),height:.6*window.screen.height,graphHeight:.6*window.screen.height*zoom-50,shaded:{orientation:"bottom"}};for(currentGraphStyle&&(r.style=currentGraphStyle);0!==visualization.childElementCount;)visualization.removeChild(visualization.firstChild);new vis.Graph2d(visualization,t,groups,r)}async function fetchGraph(){await fetchStock(),await fetchIndexes(),updateSelects(),updateGraph()}