const selectStyle=document.querySelector(".graphs__style__select"),zoomSlider=document.querySelector(".graphs__slider"),selects=document.querySelectorAll(".selects__input"),visualization=document.getElementById("visualization"),groups=new vis.DataSet;let stock={},indexes={},currentIndex,currentStock,currentGraphStyle,zoom=1;function parseResult(e,n){const r=JSON.parse(e).spark.result[0].response[0];return r.timestamp.map((e,t)=>({x:new Date(1e3*e).toLocaleDateString("ru").split(".").reverse().join("-"),y:r.indicators.quote[0].close[t],group:n}))}document.addEventListener("DOMContentLoaded",fetchGraph),selects.forEach(t=>{t.addEventListener("change",e=>{"stock"===t.id&&(currentStock=e.target.value),"indexes"===t.id&&(currentIndex=e.target.value),updateGraph()})}),selectStyle.addEventListener("change",e=>{currentGraphStyle=e.target.value,updateGraph()}),zoomSlider.addEventListener("change",e=>{zoom=e.target.value,console.log(e.target.value),updateGraph()});async function fetchStock(){stock={Microsoft:parseResult(msft,0),Gazprom:parseResult(gazprom,0),Apple:parseResult(apple,0)}}async function fetchIndexes(){indexes={IMOEX:parseResult(imoex,1),Nasdaq:parseResult(nasdaq,1),"S&P 500":parseResult(snp500,1)}}function updateSelects(){const e=Object.entries(stock).map(([e])=>e),t=Object.entries(indexes).map(([e])=>e);for(;0!==selects[0].childElementCount;)selects[0].removeChild(selects[0].firstChild);for(;0!==selects[1].childElementCount;)selects[1].removeChild(selects[1].firstChild);e.forEach(e=>{const t=document.createElement("option");t.innerHTML=e,t.setAttribute("value",e),selects[0].appendChild(t)}),t.forEach(e=>{const t=document.createElement("option");t.innerHTML=e,t.setAttribute("value",e),selects[1].appendChild(t)}),currentIndex=t[0],currentStock=e[0]}function updateGraph(){let e=[...stock[currentStock],...indexes[currentIndex]];var t=new vis.DataSet(e);const n=e.reduce((e,t)=>new Date(t.x).getTime()<e.getTime()?new Date(t.x):e,new Date(e[0].x)),r=e.reduce((e,t)=>new Date(t.x).getTime()>e.getTime()?new Date(t.x):e,new Date(e[0].x));n.setDate(n.getDate()-1),r.setDate(r.getDate()+1);const s={start:n.toLocaleDateString("ru").split(".").reverse().join("-"),end:r.toLocaleDateString("ru").split(".").reverse().join("-"),height:.6*window.screen.height,graphHeight:.6*window.screen.height*zoom-50,shaded:{orientation:"bottom"}};for(currentGraphStyle&&(s.style=currentGraphStyle);0!==visualization.childElementCount;)visualization.removeChild(visualization.firstChild);new vis.Graph2d(visualization,t,groups,s)}async function fetchGraph(){await fetchStock(),await fetchIndexes(),updateSelects(),updateGraph()}